<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <link rel="stylesheet" type="text/css" href="/stylesheets/template1.css">
    <meta charset="utf-8">
    <title></title>
    <style>
      .selected-list {
        font-weight: bold;
      }
      .task-name input:checked + label {
        text-decoration: line-through;
      }
    </style>
  </head>

  <script type="text/javascript">

    // Change the templates
    function ChangeTemplate(num){
      var oldlink = document.getElementsByTagName("link").item(0);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
        newlink.setAttribute("type", "text/css");
      switch(num){
        case 1:
          newlink.setAttribute("href", "/stylesheets/template1.css");
          break;
        case 2:
          newlink.setAttribute("href", "/stylesheets/template2.css");
          break;
        case 3:
          newlink.setAttribute("href", "/stylesheets/template3.css");
          break;
      }
      document.getElementsByTagName("head").item(0).replaceChild(newlink, oldlink);
    }
  </script>

  <body onload="Time()">
    <div class="bg">

        <div class="template">
        Template
        </div>
        <div class="template-field">
          <button id="template1" class="template-button" onclick="ChangeTemplate(1)"></button>
          <button id="template2" class="template-button" onclick="ChangeTemplate(2)"></button>
          <button id="template3" class="template-button" onclick="ChangeTemplate(3)"></button><br>
          <button id="template4" class="template-button" onclick="ChangeTemplate(4)"></button>
          <button id="template5" class="template-button" onclick="ChangeTemplate(5)"></button>
          <button id="template6" class="template-button" onclick="ChangeTemplate(6)"></button>
        </div>

      <form class="logout-form" action="/logout?_method=DELETE" method="post" logout-form>
        <button type="submit">Log Out</button>
      </form>

      <form class="del-user-form" action="/del_user" method="post" del-user-form>
        <button type="submit">Delete Account</button>
      </form>

      Current time is:<div id="txt"></div>

      <div class="all-lists">
        <h2 class="task-list-title">My lists</h2>

        <ul class="lists" data-lists></ul>

        <form class="new-list-form" action="/add_list" method="post" new-list-form>
          <input type="text" name="list" class="new list" placeholder="new list name">
          <button type="" class="btn create">+</button>
        </form>
      </div>

      <div class="display-list" list-display-container>
        <div class="header">
          <h2 class="list-title" list-title></h2>
          <p class="task-count" list-count></p>
        </div>

        <div class="body">
          <div class="tasks" data-tasks></div>

          <form class="new-task-form" action="/add_task" method="post" new-task-form>
            <input type="text" name="id" hidden>
            <input type="text" name="task" class="new task" placeholder="new task name">

            <div class="">
              <input type="text" name="day" value="" hidden>
              <input type="checkbox" name="sunday" value="0" id="sunday"><label for="sunday">sunday</label><br>
              <input type="checkbox" name="monday" value="1" id="monday"><label for="monday">monday</label><br>
              <input type="checkbox" name="tuesday" value="2" id="tuesday"><label for="tuesday">tuesday</label><br>
              <input type="checkbox" name="wednesday" value="3" id="wednesday"><label for="wednesday">wednesday</label><br>
              <input type="checkbox" name="thursday" value="4" id="thursday"><label for="thursday">thursday</label><br>
              <input type="checkbox" name="friday" value="5" id="friday"><label for="friday">friday</label><br>
              <input type="checkbox" name="saturday" value="6" id="saturday"><label for="saturday">saturday</label>
            </div>

            <input type="time" name="time" value="">
            <button class="btn create">+</button>
          </form>

          <form class="del-list-form" action="/del_list" method="post" del-list-form>
            <input type="text" name="id" hidden>
            <button class="btn delete">Delete list</button>
          </form>
        </div>
      </div>

      <form class="" action="" method="post" update-list-from hidden>
        <input type="text" name="list_id">
        <input type="text" name="task_id">
        <input type="text" name="complete">
      </form>

      <template id="list-template">
        <li class="list-name"></li>
      </template>

      <template id="task-template">
        <div class="task-name">
          <input type="checkbox">
          <label></label>
          <p></p>
          <button type="button" name="button">X</button>
        </div>
      </template>
    </div>
  </body>
  <script>
    const logoutForm = document.querySelector('[logout-form]')

    const listContainer = document.querySelector('[data-lists]')
    const newListForm = document.querySelector('[new-list-form]')
    const delListForm = document.querySelector('[del-list-form]')
    const listTemplate = document.getElementById('list-template')

    const listDisplayContainer = document.querySelector('[list-display-container]')
    const listTitleElement = document.querySelector('[list-title]')
    const listCountElement = document.querySelector('[list-count]')
    const taskContainer = document.querySelector('[data-tasks]')
    const newTaskForm = document.querySelector('[new-task-form]')
    const updateListForm = document.querySelector('[update-list-from]')
    const taskTemplate = document.getElementById('task-template')

    const LOCAL_STORAGE_SELECTED_LIST_ID_KEY = 'task.selectedListId'

    let list = <%- list %>
    let selectedListId = localStorage.getItem(LOCAL_STORAGE_SELECTED_LIST_ID_KEY)

    listContainer.addEventListener('click', evt => {
      if (evt.target.tagName == 'LI') {
        selectedListId = evt.target.id
        saveSelectedListId()
        clearElement(taskContainer)
        render()
      }
    })

    taskContainer.addEventListener('click', evt => {
      if (evt.target.tagName == 'INPUT') {
        let selectedList = list.find(list => list.id == selectedListId)
        selectedTask = selectedList.tasks.find(task => task.id == evt.target.id)
        updateListForm.complete.value = evt.target.checked
        updateListForm.task_id.value = selectedTask.id
        updateListForm.list_id.value = selectedListId
        updateListForm.action = '/save_complete'
        updateListForm.submit()
      } else if (evt.target.tagName == 'BUTTON') {
        let selectedList = list.find(list => list.id == selectedListId)
        selectedTask = selectedList.tasks.find(task => task.id == evt.target.parentElement.firstElementChild.id)
        updateListForm.task_id.value = selectedTask.id
        updateListForm.list_id.value = selectedListId
        updateListForm.action = '/del_task'
        updateListForm.submit()
      }
    })

    logoutForm.addEventListener('submit', evt => {
      evt.preventDefault()
      selectedListId = null
      saveSelectedListId()
      logoutForm.submit()
    })

    newListForm.addEventListener('submit', evt => {
      evt.preventDefault()
      const newList = newListForm.list.value
      if (newList == '') return
      newListForm.submit()
    })

    delListForm.addEventListener('submit', evt => {
      evt.preventDefault()
      const delList = selectedListId
      if (delList == null || delList == 'null') return
      delListForm.id.value = delList
      selectedListId = null
      saveSelectedListId()
      delListForm.submit()
    })

    newTaskForm.addEventListener('submit', evt => {
      evt.preventDefault()
      const newTask = newTaskForm.task.value
      if (newTask == '') return
      newTaskForm.id.value = selectedListId
      var day = []
      var selected = [newTaskForm.sunday.checked,newTaskForm.monday.checked,newTaskForm.tuesday.checked,newTaskForm.wednesday.checked,newTaskForm.thursday.checked,newTaskForm.friday.checked,newTaskForm.saturday.checked]
      for (var i = 0; i < selected.length; i++) {
        if (selected[i]) {
          day.push(i)
        }
      }
      newTaskForm.day.value = day
      newTaskForm.time.value = newTaskForm.time.value + ':' + '00'
      newTaskForm.submit()
    })

    function saveSelectedListId() {
      localStorage.setItem(LOCAL_STORAGE_SELECTED_LIST_ID_KEY, selectedListId)
    }

    function render() {
      clearElement(listContainer)
      renderLists()
      if (selectedListId == null || selectedListId == 'null') {
        listDisplayContainer.style.display = 'none'
      } else {
        let selectedList = list.find(list => list.id == selectedListId)
        selectedTasks = selectedList.tasks
        renderTaskCount(selectedTasks)
        renderTasks(selectedTasks)
        listDisplayContainer.style.display = ''
        listTitleElement.innerText = list.find(list => list.id == selectedListId).name
      }
    }

    function Time() {
      const today = new Date()
      const day = today.getDay()
      const hour = today.getHours()
      const minute = today.getMinutes()
      const second = today.getSeconds()

      setTimeout('Time()',1000)
      document.getElementById('txt').innerHTML =hour + ":" + minute + ":" + second

      list.forEach(list => {
        task = list.tasks
        task.forEach(task => {
          if (task.complete) {
            if (task.date.includes(day)) {
              if (task.time.includes(hour + ':' + minute + ':' + second)) {
                updateListForm.complete.value = false
                updateListForm.task_id.value = task.id
                updateListForm.list_id.value = list.id
                updateListForm.action = '/save_complete'
                updateListForm.submit()
              }
            }
          }
        })
      })
    }

    function renderTasks(selectedTasks) {
      selectedTasks.forEach(task => {
        const taskElement = document.importNode(taskTemplate.content, true)
        const checkbox = taskElement.querySelector('input')
        checkbox.id = task.id
        checkbox.checked = task.complete
        const label = taskElement.querySelector('label')
        label.htmlFor = task.id
        label.innerText = task.name
        const paragraph = taskElement.querySelector('p')

        paragraph.innerText = task.date + ' ' +task.time
        taskContainer.appendChild(taskElement)
      })
    }

    function renderTaskCount(selectedTasks) {
      const incompleteTaskCount = selectedTasks.filter(task => !task.complete).length
      if (incompleteTaskCount == 1) {
        var incompleteTaskString = `${incompleteTaskCount} task remaining`
      } else {
        var incompleteTaskString = `${incompleteTaskCount} tasks remaining`
      }
      listCountElement.innerText = incompleteTaskString
    }

    function renderLists() {
      list.forEach(list => {
        const listElement = document.importNode(listTemplate.content, true)
        const li = listElement.querySelector('li')
        li.id = list.id
        li.innerText = list.name
        if (list.id == selectedListId) {
          li.classList.add('selected-list')
        }
        listContainer.appendChild(listElement)
      })
    }

    function clearElement(element) {
      while (element.firstChild) {
        element.removeChild(element.firstChild)
      }
    }

    render()
  </script>
</html>
